rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user's role from Firestore
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check if user is accessing their own document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if a provider is approved
    function isApprovedProvider(providerId) {
      return exists(/databases/$(database)/documents/providers/$(providerId)) &&
             (get(/databases/$(database)/documents/providers/$(providerId)).data.approvalStatus == 'approved' ||
              (!('approvalStatus' in get(/databases/$(database)/documents/providers/$(providerId)).data) &&
               get(/databases/$(database)/documents/providers/$(providerId)).data.verified == true));
    }
    
    // Helper function to check if authenticated user is the provider for a consultation
    function isApprovedProviderForConsultation(providerId) {
      return isAuthenticated() &&
             request.auth.token.email != null &&
             exists(/databases/$(database)/documents/providers/$(providerId)) &&
             get(/databases/$(database)/documents/providers/$(providerId)).data.email == request.auth.token.email &&
             (get(/databases/$(database)/documents/providers/$(providerId)).data.approvalStatus == 'approved' ||
              (!('approvalStatus' in get(/databases/$(database)/documents/providers/$(providerId)).data) &&
               get(/databases/$(database)/documents/providers/$(providerId)).data.verified == true));
    }
    
    // Users Collection
    match /users/{userId} {
      // Allow users to read their own document
      allow read: if isOwner(userId);
      
      // Allow admins to read all user documents
      allow read: if isAdmin();
      
      // Allow authenticated users to read FCM tokens for sending notifications
      allow read: if isAuthenticated();
      
      // Allow users to create their own document
      allow create: if isOwner(userId) &&
                     (
                       !('role' in request.resource.data) ||
                       (request.resource.data.role == 'customer' || request.resource.data.role == 'provider')
                     );
      
      // Allow users to update their own document
      allow update: if isOwner(userId) && 
                     (
                       !('role' in request.resource.data) ||
                       (!('role' in resource.data) && 
                        (request.resource.data.role == 'customer' || request.resource.data.role == 'provider')) ||
                       (('role' in resource.data) && 
                        resource.data.role == request.resource.data.role)
                     );
      
      // Allow admins to update any user document
      allow update: if isAdmin();
      
      // Only admins can delete
      allow delete: if isAdmin();
      
      // Saved Addresses Subcollection
      match /savedAddresses/{addressId} {
        // Allow users to read their own saved addresses
        allow read: if isAuthenticated() && userId == request.auth.uid;
        
        // Allow users to create their own saved addresses
        allow create: if isAuthenticated() && userId == request.auth.uid;
        
        // Allow users to update their own saved addresses
        allow update: if isAuthenticated() && userId == request.auth.uid;
        
        // Allow users to delete their own saved addresses
        allow delete: if isAuthenticated() && userId == request.auth.uid;
        
        // Allow admins to read/update/delete all saved addresses
        allow read, update, delete: if isAdmin();
      }
    }
    
    // Role Change Logs Collection (Admin only)
    match /roleChangeLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if false;
    }
    
    // Consultations Collection
    match /consultations/{consultationId} {
      // Allow customers to read their own consultations
      allow read: if isAuthenticated() && 
                    (resource.data.customerId == request.auth.uid ||
                     resource.data.patientId == request.auth.uid); // Backward compatibility
      
      // Allow providers to read consultations where they are assigned
      allow read: if isAuthenticated() && 
                    (('providerId' in resource.data &&
                      resource.data.providerId == request.auth.uid) ||
                     ('doctorId' in resource.data &&
                      isApprovedProviderForConsultation(resource.data.doctorId))); // Backward compatibility
      
      // Allow admins to read all consultations
      allow read: if isAdmin();
      
      // Allow authenticated users to create consultations
      allow create: if isAuthenticated() && 
                      (request.resource.data.customerId == request.auth.uid ||
                       request.resource.data.patientId == request.auth.uid); // Backward compatibility
      
      // Allow customers to update their own consultations
      allow update: if isAuthenticated() && 
                       (resource.data.customerId == request.auth.uid ||
                        resource.data.patientId == request.auth.uid); // Backward compatibility
      
      // Allow providers to update consultations where they are assigned OR to accept pending consultations
      allow update: if isAuthenticated() && 
                       (
                         // Provider is already assigned
                         ('providerId' in resource.data &&
                          resource.data.providerId == request.auth.uid) ||
                         ('doctorId' in resource.data &&
                          isApprovedProviderForConsultation(resource.data.doctorId)) ||
                         // Provider is accepting a pending consultation (no providerId yet)
                         (!('providerId' in resource.data) &&
                          !('doctorId' in resource.data) &&
                          request.resource.data.providerId == request.auth.uid &&
                          request.resource.data.status == 'accepted')
                       );
      
      // Allow admins to update any consultation
      allow update: if isAdmin();
      
      // Allow admins to delete consultations
      allow delete: if isAdmin();
    }
    
    // Providers Collection
    match /providers/{providerId} {
      // Allow everyone to read approved provider profiles
      allow read: if resource.data.approvalStatus == 'approved' || 
                     (!('approvalStatus' in resource.data) && resource.data.verified == true);
      
      // Allow providers to read their own profile (by UID or email)
      allow read: if isAuthenticated() && 
                     (providerId == request.auth.uid ||
                      (request.auth.token.email != null &&
                       'email' in resource.data &&
                       resource.data.email == request.auth.token.email));
      
      // Allow admins to read all provider profiles
      allow read: if isAdmin();
      
      // Allow authenticated users to read FCM tokens from providers collection
      allow read: if isAuthenticated() && 
                    (request.query.limit == null || request.query.limit <= 10);
      
      // Allow providers to create their own profile
      allow create: if isAuthenticated() && 
                     request.resource.data.email == request.auth.token.email &&
                     request.resource.data.approvalStatus == 'pending';
      
      // Allow providers to update their own profile (by UID or email, but cannot change approvalStatus or serviceFee)
      allow update: if isAuthenticated() && 
                     (providerId == request.auth.uid ||
                      (request.auth.token.email != null &&
                       'email' in resource.data &&
                       resource.data.email == request.auth.token.email)) &&
                     (!('approvalStatus' in request.resource.data) ||
                      request.resource.data.approvalStatus == resource.data.approvalStatus) &&
                     (!('serviceFee' in request.resource.data) ||
                      request.resource.data.serviceFee == resource.data.serviceFee);
      
      // Admins can create/update/delete any provider profile
      allow create, update, delete: if isAdmin();
    }
    
    // Job Cards Collection
    match /jobCards/{jobCardId} {
      // Allow customers to read their own job cards
      allow read: if isAuthenticated() && 
                    resource.data.customerId == request.auth.uid;
      
      // Allow providers to read their own job cards
      allow read: if isAuthenticated() && 
                    resource.data.providerId == request.auth.uid;
      
      // Allow admins to read all job cards
      allow read: if isAdmin();
      
      // Allow providers to create job cards when accepting bookings
      allow create: if isAuthenticated() && 
                     request.resource.data.providerId == request.auth.uid &&
                     request.resource.data.status == 'accepted';
      
      // Allow providers to update their own job cards (status changes)
      allow update: if isAuthenticated() && 
                       resource.data.providerId == request.auth.uid;
      
      // Allow customers to update their own job cards (e.g., cancel)
      allow update: if isAuthenticated() && 
                       resource.data.customerId == request.auth.uid &&
                       request.resource.data.status == 'cancelled';
      
      // Allow admins to update/delete any job card
      allow update, delete: if isAdmin();
    }
    
    // Reviews Collection
    match /reviews/{reviewId} {
      // Allow everyone to read reviews (public)
      allow read: if true;
      
      // Allow customers to create reviews
      allow create: if isAuthenticated() && 
                      request.resource.data.customerId == request.auth.uid &&
                      request.resource.data.rating >= 1 &&
                      request.resource.data.rating <= 5;
      
      // Allow customers to update their own reviews (but not rating)
      allow update: if isAuthenticated() && 
                      resource.data.customerId == request.auth.uid &&
                      (!('rating' in request.resource.data) ||
                       request.resource.data.rating == resource.data.rating);
      
      // Allow admins to delete reviews
      allow delete: if isAdmin();
    }
    
    // Service Categories Collection
    match /serviceCategories/{categoryId} {
      // Allow everyone to read service categories
      allow read: if true;
      
      // Only admins can create/update/delete categories
      allow create, update, delete: if isAdmin();
    }
    
    // Payments Collection
    match /payments/{paymentId} {
      // Allow customers to read their own payment records
      allow read: if isAuthenticated() && 
                    resource.data.consultationId != null &&
                    exists(/databases/$(database)/documents/consultations/$(resource.data.consultationId)) &&
                    (get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.customerId == request.auth.uid ||
                     get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.patientId == request.auth.uid); // Backward compatibility
      
      // Allow providers to read payment records for their consultations
      allow read: if isAuthenticated() && 
                    resource.data.consultationId != null &&
                    exists(/databases/$(database)/documents/consultations/$(resource.data.consultationId)) &&
                    (get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.providerId == request.auth.uid ||
                     (get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.doctorId != null &&
                      isApprovedProviderForConsultation(get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.doctorId))); // Backward compatibility
      
      // Allow admins to read all payment records
      allow read: if isAdmin();
      
      // Allow authenticated users to create payment records for their own consultations
      allow create: if isAuthenticated() && 
                      request.resource.data.consultationId != null &&
                      exists(/databases/$(database)/documents/consultations/$(request.resource.data.consultationId)) &&
                      (get(/databases/$(database)/documents/consultations/$(request.resource.data.consultationId)).data.customerId == request.auth.uid ||
                       get(/databases/$(database)/documents/consultations/$(request.resource.data.consultationId)).data.patientId == request.auth.uid); // Backward compatibility
      
      // Allow admins to update/delete payment records
      allow update, delete: if isAdmin();
    }
    
    // Default: Deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
